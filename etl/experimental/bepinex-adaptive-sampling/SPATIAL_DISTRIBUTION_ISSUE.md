# Spatial Distribution Issue - Root Cause Analysis

**Date:** 2025-10-14
**Issue:** BepInEx biome data shows biomes in spatially incorrect locations compared to in-game accessibility

---

## Problem Statement

The biome maps generated by BepInEx show **DeepNorth and Ashlands appearing in incorrect hemispheres**:

- **DeepNorth (ID 256)**: 49.6% appears in southern hemisphere (should be ~0%)
- **Ashlands (ID 512)**: 48.7% appears in northern hemisphere (should be ~0%)
- **Center contamination**: 27.3% DeepNorth + 2.3% Ashlands in center 25% (should be minimal)

This contradicts player experience where:
- DeepNorth is isolated to northern crescent
- Ashlands is isolated to southern crescent
- Center region is dominated by Meadows/BlackForest/Plains

---

## Root Cause Analysis

### What We Found

The BepInEx `BiomeExporter.cs` code is **working correctly**:

```csharp
// Line 171
return WorldGenerator.instance.GetBiome(worldX, worldZ);
```

This calls Valheim's **native biome determination function**. The spatial distribution we're seeing is what **Valheim's WorldGenerator actually returns**.

### The Discrepancy

**Theory:** Valheim's biome generation has **two layers**:

1. **WorldGenerator.GetBiome()** - Raw biome assignment (what we sample)
2. **Game accessibility layer** - Filters/masks certain biomes based on location

The game may use additional logic beyond `GetBiome()` to:
- Prevent DeepNorth spawns south of equator
- Prevent Ashlands spawns north of equator
- Force specific biomes in center region
- Apply distance-from-center rules

### Supporting Evidence

Looking at Valheim's spawn mechanics and biome-specific behaviors:
- Boss altars have specific biome requirements
- Certain resources only spawn in hemisphere-appropriate biomes
- Players consistently report crescent patterns for DeepNorth/Ashlands

---

## Detailed Spatial Analysis

### By Region (512×512 grid)

| Region | DeepNorth % | Ashlands % | Expected |
|--------|-------------|------------|----------|
| North (top 25%) | 34.8% | 19.0% | DeepNorth high, Ashlands low |
| South (bottom 25%) | 34.6% ⚠️ | 20.0% | DeepNorth low, Ashlands high |
| Center (±25%) | 27.3% ⚠️ | 2.3% ⚠️ | Both minimal |
| Equator (±12.5%) | 28.3% ⚠️ | 8.9% ⚠️ | Both should taper |

### Key Findings

1. **DeepNorth is nearly symmetric** (34.8% north vs 34.6% south)
2. **Ashlands is nearly symmetric** (19.0% north vs 20.0% south)
3. **Both heavily present at equator** (28.3% + 8.9% = 37.2% combined)
4. **No clear hemispheric preference** in raw WorldGenerator data

---

## Proposed Solutions

### Solution 1: Post-Processing Spatial Filter (Recommended)

Apply hemisphere-based filtering to biome data **after** BepInEx sampling.

**Implementation:**
```python
# scripts/apply_spatial_filter.py

def apply_spatial_biome_rules(biome_map, resolution):
    """
    Apply Valheim's accessibility rules to biome data.
    Filters biomes that shouldn't exist in certain regions.
    """
    center = resolution // 2
    filtered_map = biome_map.copy()

    for y in range(resolution):
        for x in range(resolution):
            biome_id = biome_map[y, x]

            # Calculate distance from center (normalized 0-1)
            dx = (x - center) / center
            dy = (y - center) / center
            dist_from_center = np.sqrt(dx**2 + dy**2)

            # Calculate hemisphere position (-1 = south, +1 = north)
            hemisphere = (center - y) / center

            # Rule 1: DeepNorth only in northern hemisphere
            if biome_id == 256 and hemisphere < -0.1:
                # Replace with most likely alternative
                filtered_map[y, x] = get_fallback_biome(biome_map, y, x, exclude=[256])

            # Rule 2: Ashlands only in southern hemisphere
            if biome_id == 512 and hemisphere > 0.1:
                filtered_map[y, x] = get_fallback_biome(biome_map, y, x, exclude=[512])

            # Rule 3: Center region (inner 25%) should be temperate biomes
            if dist_from_center < 0.25:
                if biome_id in [256, 512]:  # DeepNorth or Ashlands
                    # Force to Meadows/BlackForest/Plains
                    filtered_map[y, x] = get_temperate_biome(biome_map, y, x)

    return filtered_map
```

**Pros:**
- Non-invasive (doesn't modify BepInEx)
- Configurable rules
- Can be refined based on player validation
- Preserves raw data for analysis

**Cons:**
- Adds processing step
- May introduce visual artifacts at boundaries
- Rules are heuristic, not authoritative

---

### Solution 2: Alternative Valheim API

Research if Valheim exposes a **"playable biome" API** beyond `WorldGenerator.GetBiome()`.

**Potential APIs to investigate:**
```csharp
// Hypothesis: Game may use different method for spawn/accessibility
HeightmapBuilder.GetBiome()  // vs WorldGenerator.GetBiome()
BiomeArea.GetBiome()          // Area-based queries
ZoneSystem.GetBiome()         // Zone-level biome determination
```

**Implementation:**
Modify `BiomeExporter.cs` line 171 to call alternative API if found.

**Pros:**
- Authoritative from Valheim source
- No heuristics needed
- Matches player experience exactly

**Cons:**
- May not exist
- Requires Valheim source code analysis
- Could be complex accessibility logic, not simple API

---

### Solution 3: Hybrid - Sample + Player Validation

Generate biome maps from BepInEx, then **validate against player exploration data**.

**Process:**
1. Export raw BepInEx data (what we have now)
2. Player explores world, records actual biomes encountered
3. Build validation dataset: `{(x, z): in_game_biome}`
4. Train spatial filter based on discrepancies
5. Apply learned filter to future seeds

**Pros:**
- Data-driven, not heuristic
- Scales to any seed
- Can capture complex spatial rules

**Cons:**
- Requires player exploration time
- Need multiple seeds for generalization
- Complex ML/statistical modeling

---

## Immediate Action Plan

### Phase 1: Validation (Week 1)

1. **Manual spot-check** reference image regions:
   - Sample 10 locations from reference image
   - Note (x, z, expected_biome)
   - Compare to BepInEx data at same coordinates
   - Quantify error rate

2. **Document spatial rules** from reference:
   - Map DeepNorth boundary (latitude threshold)
   - Map Ashlands boundary (latitude threshold)
   - Identify center region definition

### Phase 2: Filter Implementation (Week 2)

1. Implement `scripts/apply_spatial_filter.py`
2. Add rules based on Phase 1 findings
3. Run on test seed `hkLycKKCMI`
4. Generate filtered biome map
5. Visual comparison: raw vs filtered vs reference

### Phase 3: Validation & Iteration (Week 3)

1. Run visual validation script on filtered output
2. Compare metrics: raw vs filtered vs reference
3. Refine filter rules based on results
4. Document final spatial rules in `global/data/`

---

## Expected Outcomes

**Before filtering:**
- Grade F (34.56%)
- DeepNorth/Ashlands everywhere
- 49.6% DeepNorth in wrong hemisphere

**After filtering:**
- Grade B/A (target 85%+)
- DeepNorth isolated to north
- Ashlands isolated to south
- Center region temperate biomes

---

## Questions for Investigation

1. **Does Valheim use heightmap for biome placement?**
   - Low elevation → Swamp/Ocean
   - High elevation → Mountain
   - Could explain spatial patterns

2. **Are biome "zones" predefined?**
   - Does WorldGenerator have hard-coded latitude thresholds?
   - Are there ring-based biome rules (distance from center)?

3. **What is the reference image source?**
   - If from https://valheim-map.world or similar → they may already apply filtering
   - If from in-game mod/overlay → shows actual spawn mechanics

4. **Can we access Valheim's decompiled source?**
   - ILSpy/dnSpy on game DLLs
   - Look for biome placement logic beyond WorldGenerator.GetBiome()

---

## Files to Create

- `scripts/apply_spatial_filter.py` - Post-processing filter
- `scripts/validate_spatial_rules.py` - Compare filtered vs reference
- `global/data/biome-spatial-rules.yml` - Hemisphere/distance rules
- `docs/SPATIAL_FILTERING.md` - User guide for filtered maps

---

## Conclusion

**The BepInEx sampling is working correctly** - it's faithfully reporting what `WorldGenerator.GetBiome()` returns.

**The mismatch is between:**
- What WorldGenerator **calculates** (raw biome IDs)
- What the game **allows players to access** (filtered/masked biomes)

**Solution:** Apply post-processing spatial filter based on known accessibility patterns (DeepNorth north, Ashlands south, temperate center).

This is analogous to:
- **Raw data:** All possible biomes at all locations (procedural generation)
- **Playable data:** Subset constrained by game design rules (what players see)

Our maps should represent **playable reality**, not raw procedural output.
